<div class="container">
    <div hx-trigger="load"
         hx-get="/api/sidebar/update?current_path=/speedtest"
         hx-target="#sidebar-container"
         hx-swap="innerHTML"
         class="hidden"></div>
    <h1>Speed Test</h1>
    <p>Test your internet connection speed</p>
    
    <div class="speed-test-container">
        <div class="speed-test-controls">
            <button id="start-speed-test" class="btn btn--primary d-inline-flex" onclick="startSpeedTest()">
                <span class="test-icon">üöÄ</span>
                Start Speed Test
            </button>
            <button id="stop-speed-test" class="btn btn--secondary d-inline-flex hidden" onclick="stopSpeedTest()">
                <span class="test-icon">‚èπÔ∏è</span>
                Stop Test
            </button>
        </div>
        
        <div class="speed-test-results hidden" id="speed-test-results">
            <div class="speed-metrics">
                <div class="ui-card">
                    <div class="ui-card__header">
                        <h3>Download Speed</h3>
                    </div>
                    <div class="ui-card__body">
                        <div class="metric-value" id="download-speed">--</div>
                        <div class="metric-unit">Mbps</div>
                    </div>
                </div>
                <div class="ui-card">
                    <div class="ui-card__header">
                        <h3>Ping</h3>
                    </div>
                    <div class="ui-card__body">
                        <div class="metric-value" id="ping-value">--</div>
                        <div class="metric-unit">ms</div>
                    </div>
                </div>
            </div>
            
            <div class="progress-container">
                <div class="progress-label">Test Progress</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="progress-text" id="progress-text">Ready to start</div>
            </div>
            
            <div class="test-details ui-card">
                <div class="ui-card__header">
                    <h4>Test Details</h4>
                </div>
                <div class="ui-card__body">
                    <div class="detail-item">
                        <span class="detail-label">Test Duration:</span>
                        <span class="detail-value" id="test-duration">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Data Transferred:</span>
                        <span class="detail-value" id="data-transferred">--</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
(() => {
    'use strict';
    
    // Speed test state
    let isTestRunning = false;
    let abortController = null;
    let testResults = {
        download: null,
        ping: null
    };
    
    async function calculateHash(data) {
        // Use a simple hash function that works in all browsers
        let hash = 0;
        if (data.length === 0) return '00000000';
        
        for (let i = 0; i < data.length; i++) {
            const char = data.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash | 0; // Convert to 32-bit signed integer
        }
        
        // Convert to positive hex string (8 characters)
        return (hash >>> 0).toString(16).padStart(8, '0');
    }
    
    async function runPingTest() {
        const startTime = performance.now();
        
        try {
            const response = await fetch('/api/speedtest?test=ping', {
                signal: abortController?.signal
            });
            const endTime = performance.now();
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                const pingTime = Math.round(endTime - startTime);
                testResults.ping = pingTime;
                return pingTime;
            } else {
                throw new Error(result.message || 'Ping test failed');
            }
        } catch (error) {
            if (error.name === 'AbortError') {
                throw new Error('Test was stopped');
            }
            console.error('Ping test error:', error);
            throw error;
        }
    }
    
    async function runDownloadTestWithProgress(progressFill, progressText) {
        const chunkSize = 1048576; // 1MB per chunk
        const numberOfChunks = 20; // 20 chunks = 20MB total
        
        const startTime = performance.now();
        let totalDownloadedBytes = 0;
        let allHashes = [];
        
        try {
            // Download 20 chunks of 1MB each with progress updates
            for (let i = 0; i < numberOfChunks; i++) {
                // Check if test was stopped
                if (!isTestRunning) {
                    throw new Error('Test was stopped');
                }
                
                const chunkStartTime = performance.now();
                const response = await fetch(`/api/speedtest?test=download&size=${chunkSize}&id=${i + 1}`, {
                    signal: abortController?.signal
                });
                const chunkEndTime = performance.now();
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText} (chunk ${i + 1})`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    const serverHash = result.hash;
                    const calculatedHash = await calculateHash(data);
                    const chunkDuration = (chunkEndTime - chunkStartTime) / 1000;
                    const chunkSpeedMbps = (data.length * 8) / (chunkDuration * 1000000);
                    
                    // Verify hash match
                    const hashMatch = serverHash === calculatedHash;
                    if (!hashMatch) {
                        console.warn(`Hash mismatch for chunk ${i + 1}: server=${serverHash}, calculated=${calculatedHash}`);
                    }
                    
                    totalDownloadedBytes += data.length;
                    allHashes.push({
                        chunk: i + 1,
                        hash: calculatedHash,
                        serverHash: serverHash,
                        hashMatch: hashMatch,
                        size: data.length,
                        duration: chunkDuration,
                        speedMbps: chunkSpeedMbps
                    });
                    
                    // Update progress bar (10% for ping + 90% for download)
                    const progressPercent = 10 + ((i + 1) / numberOfChunks) * 90;
                    if (progressFill) {
                        progressFill.style.width = `${progressPercent}%`;
                    }
                    if (progressText) {
                        progressText.textContent = `Downloading chunk ${i + 1}/${numberOfChunks}... ${(totalDownloadedBytes / (1024*1024)).toFixed(1)} MB (${chunkSpeedMbps.toFixed(1)} Mbps)`;
                    }
                    
                    console.log(`Chunk ${i + 1}/${numberOfChunks}: ${chunkSpeedMbps.toFixed(2)} Mbps, Hash: ${calculatedHash} (server: ${serverHash}, match: ${hashMatch})`);
                } else {
                    throw new Error(result.message || `Download test failed (chunk ${i + 1})`);
                }
            }
            
            const endTime = performance.now();
            const totalDuration = (endTime - startTime) / 1000; // Convert to seconds
            const averageSpeedMbps = (totalDownloadedBytes * 8) / (totalDuration * 1000000); // Convert to Mbps
            
            testResults.download = {
                bytes: totalDownloadedBytes,
                duration: totalDuration,
                speedMbps: averageSpeedMbps,
                chunks: allHashes,
                totalChunks: numberOfChunks
            };
            
            return {
                bytes: totalDownloadedBytes,
                duration: totalDuration,
                speedMbps: averageSpeedMbps,
                chunks: allHashes,
                totalChunks: numberOfChunks
            };
        } catch (error) {
            if (error.name === 'AbortError' || error.message === 'Test was stopped') {
                throw new Error('Test was stopped');
            }
            console.error('Download test error:', error);
            throw error;
        }
    }
    
    async function startSpeedTest() {
        if (isTestRunning) return;
        
        isTestRunning = true;
        abortController = new AbortController();
        const resultsContainer = document.getElementById('speed-test-results');
        const downloadSpeedEl = document.getElementById('download-speed');
        const pingEl = document.getElementById('ping-value');
        const startButton = document.getElementById('start-speed-test');
        const stopButton = document.getElementById('stop-speed-test');
        const progressFill = document.getElementById('progress-fill');
        const progressText = document.getElementById('progress-text');
        const testDurationEl = document.getElementById('test-duration');
        const dataTransferredEl = document.getElementById('data-transferred');

        // Reset UI
        downloadSpeedEl.textContent = '--';
        pingEl.textContent = '--';
        testDurationEl.textContent = '--';
        dataTransferredEl.textContent = '--';
        if (progressFill) progressFill.style.width = '0%';
        if (progressText) progressText.textContent = 'Starting...';
        if (resultsContainer) resultsContainer.classList.remove('hidden');
        if (startButton) startButton.classList.add('hidden');
        if (stopButton) stopButton.classList.remove('hidden');

        try {
            // Ping
            if (progressText) progressText.textContent = 'Testing ping...';
            const pingTime = await runPingTest();
            pingEl.textContent = String(pingTime);
            if (progressFill) progressFill.style.width = '10%';
            
            // Download 20x1MB with progress updates
            if (progressText) progressText.textContent = 'Downloading 20 x 1MB chunks...';
            const downloadData = await runDownloadTestWithProgress(progressFill, progressText);
            const totalBytes = downloadData.bytes;
            const totalDuration = downloadData.duration * 1000;
            downloadSpeedEl.textContent = downloadData.speedMbps.toFixed(2);
            if (progressFill) progressFill.style.width = '100%';
            if (progressText) progressText.textContent = 'Test completed';

            // Details
            testDurationEl.textContent = `${downloadData.duration.toFixed(2)} s`;
            dataTransferredEl.textContent = `${(totalBytes / (1024*1024)).toFixed(2)} MB`;
            
            // Show success message using HTMX trigger
            if (typeof htmx !== 'undefined' && htmx.trigger) {
                htmx.trigger(document.body, 'showSuccessBar');
            }
            
        } catch (error) {
            console.error('Speed test error:', error);
            // Show error message using HTMX trigger (only if not stopped by user)
            if (error.message !== 'Test was stopped' && typeof htmx !== 'undefined' && htmx.trigger) {
                htmx.trigger(document.body, 'showErrorBar');
            } else if (error.message === 'Test was stopped' && typeof htmx !== 'undefined' && htmx.trigger) {
                // Could trigger info bar for stopped message
            }
        } finally {
            isTestRunning = false;
            abortController = null;
            if (startButton) startButton.classList.remove('hidden');
            if (stopButton) stopButton.classList.add('hidden');
            if (progressText) progressText.textContent = 'Test stopped';
        }
    }

    function stopSpeedTest() {
        if (!isTestRunning) return;
        
        // Abort all ongoing fetch requests
        if (abortController) {
            abortController.abort();
        }
        
        isTestRunning = false;
        const startButton = document.getElementById('start-speed-test');
        const stopButton = document.getElementById('stop-speed-test');
        const progressText = document.getElementById('progress-text');
        
        if (startButton) startButton.classList.remove('hidden');
        if (stopButton) stopButton.classList.add('hidden');
        if (progressText) progressText.textContent = 'Stopping test...';
    }
    
    // Global functions
    window.startSpeedTest = startSpeedTest;
    window.stopSpeedTest = stopSpeedTest;
    
    console.log('Speedtest script loaded');
})();
</script>

