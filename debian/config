#!/bin/sh
set -e

# Source debconf library.
. /usr/share/debconf/confmodule

# in preinst phase the directory doesn't exist
var='/var/lib/rpiap/env'
mkdir -p "${var}"
chown rpiap:rpiap "${var}"

dbdo() {
  fn="$1"
  secret=$2
  dbname="rpiap/${fn}"

  # get value
  if [ -f "${var}/${fn}" ]; then
    db_set "${dbname}" "`cat ${var}/${fn}`"
  fi
  db_input critical "${dbname}" || true
  db_go

  # write value to env. directory
  db_get "${dbname}"
  (
    umask 077
    echo "${RET}" > "${var}/${fn}"
    chown rpiap:rpiap "${var}/${fn}"
  )

  # clear value from the debconf DB
  if [ x"${secret}" != x ]; then
    db_set "${dbname}" "${secret}"
  fi

  # don't store restart file
  if [ x"${fn}" = xrestart ]; then
    rm -f "${var}/${fn}"
  fi
}

dbdo wlanssid
dbdo wlanpassword _
dbdo wlanchannel
dbdo wlancountry
dbdo dhcpdns
dbdo restart

exit 0
